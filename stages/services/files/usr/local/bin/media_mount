#!/usr/bin/env bash

LOG="/var/log/diskplayer.log"

echo "$(date) Start." >> ${LOG}
echo "$(date) Media change detected on device $1" >> ${LOG}

sleep 1

lsblk | grep $(echo ${1} | cut -f 3 -d '/')

if [ $? -eq 0 ]; then
    echo "$(date) Device exists on machine." >> ${LOG}
    echo "$(date) Mounting device $1 to /mnt/floppy." >> ${LOG}
    mount $1 /mnt/floppy 2>&1 >> ${LOG}
    mpc stop
    mpc clear
    if [[ -f /mnt/floppy/media.m3u ]]; then
            cat /mnt/floppy/media.m3u | mpc add
            mpc add file:///usr/local/share/diskplayer/bleep.mp3
            mpc consume on
            mpc random off
            mpc volume 30
            mpc play 1
            systemd-mount --umount /mnt/floppy
            echo "1" > /etc/diskplayer_status
    fi
else
    echo "$(date) Device does not exist on machine." >> ${LOG}
    STATUS=$(cat /etc/diskplayer_status)
    if [[ ${STATUS} = '1' ]]; then
        mpc pause
        mpc clear
        mpc add file:///usr/local/share/diskplayer/bleep.mp3
        mpc play
        echo "0" > /etc/diskplayer_status
    fi
fi
echo "$(date) End."
