#!/bin/bash -e

FAILURE=0

if [[ ${REPO_NAME} = 'blog' || ${REPO_NAME} = 'rcmd.space' ]]; then
    git clone git@git.rcmd.space:rcmd/${REPO_NAME}.git
else
    git clone --depth 1 git@git.rcmd.space:rcmd/${REPO_NAME}.git
fi

cd ${REPO_NAME} && sudo /usr/bin/make || FAILURE=1

TELEGRAM_BOT_TOKEN=$(sudo /usr/bin/jq -r .secrets.telegram.bot_token /etc/secrets/secrets.json)
TELEGRAM_CHAT_ID=$(sudo /usr/bin/jq -r .secrets.telegram.chat_id /etc/secrets/secrets.json)

if [[ ${FAILURE} = "0" ]]; then
    TEXT="ðŸ“¦ ${REPO_NAME} build completed"
else
    TEXT="â›” ${REPO_NAME} build failed"
fi

curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
    -H 'Content-Type: application/json' \
    -d "{ \"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": \"${TEXT}\" }"
