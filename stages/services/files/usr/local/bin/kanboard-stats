#!/usr/bin/env bash

TELEGRAM_BOT_TOKEN=`jq -cr .secrets.telegram_second.bot_token /etc/secrets/secrets.json`
TELEGRAM_CHAT_ID=`jq -cr .secrets.telegram_second.chat_id /etc/secrets/secrets.json`

NUMBER_OF_TASKS=`sqlite3 /var/lib/kanboard/data/db.sqlite "select count(*) from tasks where (is_active = 0 and date_completed > strftime('%s', 'now', '-24 hours') and project_id != 6) or (date_modification > strftime('%s', 'now', '-24 hours') and project_id = 6)"`

NORMAL_TASKS=`sqlite3 /var/lib/kanboard/data/db.sqlite "select '‚ãÖ ' || title from tasks where (is_active = 0 and date_completed > strftime('%s', 'now', '-24 hours') and project_id != 6) order by date_due"`
REPEATING_TASKS=`sqlite3 /var/lib/kanboard/data/db.sqlite "select '‚ãÖ ' || title from tasks where (date_modification > strftime('%s', 'now', '-24 hours') and project_id = 6) order by date_due"`

TEXT="üéâüéâüéâ \\n–°–µ–≥–æ–¥–Ω—è —è –≤—ã–ø–æ–ª–Ω–∏–ª ${NUMBER_OF_TASKS} –∑–∞–¥–∞—á:\\n\\nüèÜ –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:\\n${NORMAL_TASKS}\\n\\n‚è∞ –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–¥–∞—á–∏:\\n${REPEATING_TASKS}\\n\\n–°–µ–≥–æ–¥–Ω—è —è –º–æ–ª–æ–¥–µ—Ü!"
curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
    -H 'Content-Type: application/json' \
    -d "{ \"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": \"${TEXT}\" }"
