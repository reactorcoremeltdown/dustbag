#!/usr/bin/env bash

LOG="/var/log/diskplayer.log"

function play() {
    mpc stop 2>&1 >> ${LOG}
    mpc clear 2>&1 >> ${LOG}
    cat /mnt/floppy/media.m3u | mpc add 2>&1 >> ${LOG}
    mpc add file:///usr/local/share/diskplayer/bleep.mp3 2>&1 >> ${LOG}
    mpc consume on
    mpc random off
    mpc volume 30
    mpc play 1 2>&1 >> ${LOG}
    systemd-mount --umount /mnt/floppy 2>&1 >> ${LOG}
    echo "1" > /etc/diskplayer_status
}

function retry_mount() {
    for i in `seq 1 5`; do
        if [[ -f /mnt/floppy/media.m3u ]]; then
            echo "$(date) Successfully mounted a drive" >> ${LOG}
            break
        else
            echo "$(date) Trying to mount ${1} to /mnt/floppy, attempt ${i}..." >> ${LOG}
            systemd-mount $1 /mnt/floppy 2>&1 >> ${LOG}
        fi
        echo "$(date) Waiting for 2 seconds before next try"
        sleep 2
    done
}

echo "$(date) Start." >> ${LOG}
echo "$(date) Media change detected on device $1" >> ${LOG}

sleep 1

LENGTH=$(lsblk -A --json ${1} | jq '.blockdevices | length')

if [ ${LENGTH} -gt 0 ]; then
    echo "$(date) Device exists on machine." >> ${LOG}
    echo "$(date) Mounting device $1 to /mnt/floppy." >> ${LOG}
    retry_mount ${1}
    echo "$(date) We've made it here" >> ${LOG}
    if [[ -f /mnt/floppy/media.m3u ]]; then
        play
    else
        echo "$(date) seems like mounting has failed, not doing anything :("
    fi
else
    echo "$(date) Device does not exist on machine." >> ${LOG}
    STATUS=$(cat /etc/diskplayer_status)
    if [[ ${STATUS} = '1' ]]; then
        mpc pause
        mpc clear
        mpc add file:///usr/local/share/diskplayer/bleep.mp3
        mpc play
        echo "0" > /etc/diskplayer_status
    fi
fi
echo "$(date) End."
